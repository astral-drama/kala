# Kala Time Server Configuration for Chrony with GPS/PPS Support
# This configuration sets up the system as a precision time server
# using GPS and PPS sources from Raspberry Pi Ultimate GPS HAT

# GPS reference via gpsd shared memory driver
# SHM 0 is for GPS time (NMEA data)
refclock SHM 0 refid GPS precision 1e-1 offset 0.0 delay 0.2 noselect

# PPS reference via gpsd shared memory driver  
# SHM 1 is for PPS signal (requires GPS lock first)
refclock SHM 1 refid PPS precision 1e-9 prefer

# Alternative: PPS via kernel PPS driver (if /dev/pps0 exists)
# refclock PPS /dev/pps0 refid PPS1 precision 1e-9 prefer

# Use public NTP servers as backup sources
# These help during GPS acquisition and provide sanity checks
pool 0.pool.ntp.org iburst maxsources 2
pool 1.pool.ntp.org iburst maxsources 2  
pool 2.pool.ntp.org iburst maxsources 2
pool 3.pool.ntp.org iburst maxsources 2

# Use Debian's NTP server as additional source
server ntp.debian.org iburst

# Record the rate at which the system clock gains/losses time
driftfile /var/lib/chrony/chrony.drift

# Allow the system clock to be stepped in the first three updates
# if its offset is larger than 1 second
makestep 1.0 3

# Enable kernel synchronization of the real-time clock
rtcsync

# Allow NTP client access from local network
# Adjust these ranges to match your local network
allow 192.168.0.0/16
allow 10.0.0.0/8
allow 172.16.0.0/12
allow fe80::/10

# Serve time even if not synchronized to a time source
# Stratum 1 when using GPS/PPS
local stratum 1

# Specify file containing keys for NTP authentication
keyfile /etc/chrony/chrony.keys

# Log files location
logdir /var/log/chrony

# Log tracking measurements, statistics, and RTC
# Also log refclocks for GPS/PPS monitoring
log tracking measurements statistics rtc refclocks

# Save data between restarts for faster re-sync
dumponexit
dumpdir /var/lib/chrony

# Use hardware timestamping on all interfaces that support it
hwtimestamp *

# Increase the minimum number of selectable sources required to adjust
# the system clock (for better accuracy)
minsources 2

# Limit memory use for clients
clientloglimit 16777216

# Allow larger offset corrections when using GPS
# This helps during initial GPS acquisition
maxdistance 16.0